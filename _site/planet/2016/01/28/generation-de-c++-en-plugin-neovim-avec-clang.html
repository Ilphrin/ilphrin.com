<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/monokai-sublime.min.css">
  <link rel="stylesheet" href="/bower_components/mermaid/dist/mermaid.css">
  <link rel="icon" href="/images/LogoV1.png"/>
  <link rel="stylesheet" type="text/css" href="/bower_components/semantic/dist/semantic.css">
  <link rel="stylesheet" type="text/css" href="/css/main.css"/>
  <title>
    Kevin / Ilphrin
  </title>
  <!-- Piwik -->
  <script type="text/javascript">
    var _paq = _paq || [];
    // tracker methods like "setCustomDimension" should be called before "trackPageView"
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
      var u="//ilphrin.com/piwik/";
      _paq.push(['setTrackerUrl', u+'piwik.php']);
      _paq.push(['setSiteId', '1']);
      var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
      g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
    })();
  </script>
  <!-- End Piwik Code -->
</head>

<body itemscope itemtype="http://schema.org/Blog">
  <div class="header">
  <div class="navigation">
    <div class="title">
      <h1 style="color: #B9EFFF;" itemprop="author">Kevin <span class="slash">/</span> Ilphrin</h1>
    </div>
    <ul class="shad-effect" itemscope itemtype="http://schema.org/SiteNavigationElement">
      <li><a href="/">Accueil</a></li>
      <li><a href="/kevin/index.html">Blog</a></li>
      <li><a href="/kevin/project.html">Projets</a></li>
      <li><a href="/kevin/about.html">A propos</a></li>
      <li><a href="/feeds.xml" id="rss"><img src="/images/links/rss.png" alt="Flux RSS"/></a></li>
    </ul>
  </div>
  <div class="headerCursor">
    <img src="/images/decoration/header_01.svg" />
  </div>
</div>

    <div class="main">
        <div class="post_home" itemscope itemtype="http://schema.org/Article" itemprop="blogPost">
  <div id="post_header">
    <div id="post_title">
      <div class="cover_pic"></div>
      
        <img src="/images/decoration/default_header_article.jpg" />
      

      <svg
         xmlns:dc="http://purl.org/dc/elements/1.1/"
         xmlns:cc="http://creativecommons.org/ns#"
         xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
         xmlns:svg="http://www.w3.org/2000/svg"
         xmlns="http://www.w3.org/2000/svg"
         xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
         xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
         width="100%"
         height="110mm"
         viewBox="0 0 396.85016 173.622"
         sodipodi:docname="logoV2.svg">
        <metadata
           id="metadata7">
          <rdf:RDF>
            <cc:Work
               rdf:about="">
              <dc:format>image/svg+xml</dc:format>
              <dc:type
                 rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
              <dc:title></dc:title>
            </cc:Work>
          </rdf:RDF>
        </metadata>
        <g
           id="layer1"
           transform="translate(0,-878.73978)">
          <g
             id="g4240"
             transform="translate(-173.94827,758.01847)">
            <path
               inkscape:connector-curvature="0"
               id="path4152"
               d="m 178.797,180.34802 388.90873,0"
               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1" />
            <g
               transform="translate(0.5,0)"
               id="g4171">
              <path
                 style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                 d="m 567.70573,180.34802 0,-54.2957"
                 id="path4154"
                 inkscape:connector-curvature="0" />
              <path
                 style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                 d="m 567.70573,234.64372 0,-54.2957"
                 id="path4154-3"
                 inkscape:connector-curvature="0" />
            </g>
            <g
               id="g4171-6"
               transform="translate(-389.40873,0)">
              <path
                 style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                 d="m 567.70573,180.34802 0,-54.2957"
                 id="path4154-7"
                 inkscape:connector-curvature="0" />
              <path
                 style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
                 d="m 567.70573,234.64372 0,-54.2957"
                 id="path4154-3-5"
                 inkscape:connector-curvature="0" />
            </g>
            <path
               inkscape:connector-curvature="0"
               id="path4196"
               d="M 373.28787,180.36362 567.87002,287.49944"
               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:1.02377963px;stroke-linecap:round;stroke-linejoin:miter;stroke-opacity:1" />
            <path
               inkscape:connector-curvature="0"
               id="path4196-3"
               d="M 373.21419,180.37989 178.13336,287.51442"
               style="fill:none;fill-rule:evenodd;stroke:#000000;stroke-width:1.02508438px;stroke-linecap:round;stroke-linejoin:miter;stroke-opacity:1" />
          </g>
        </g>
      </svg>

      <h1 itemprop="name"> Génération de code C++ en plugin Neovim avec CLang</h1>
      <span>28

Janvier
  
2016
</span>
    </div>
  </div>
  <div class="content" itemprop="articleBody">
    
      
    
      
    
      
        
        
    
    <div class="similar_articles">
      <h2>Articles similaires</h2>
      <ul>
        
          
        
          
        
          
            <li>
              <a href="/planet/2016/12/30/oni-un-gui-pour-neovim.html">Oni: Un GUI sympa pour Neovim</a>
              <p datetime="28 January 2016">30

Décembre

2016
</p>
              <hr />
              <div class="similar_excerpt">
                <p><p>Ca faisait longtemps que je n’avais pas parlé de <a href="https://neovim.io/">Neovim</a> hein? Eh bien pour la peine je vais présenter un GUI fait avec Electron pour Neovim qui claque</p>

</p>
              </div>
            </li>
          
        
          
        
          
        
          
            <li>
              <a href="/planet/2016/12/12/update-neovim-1-7-tour-des-fonctionalites.html">Update: Neovim 0.1.7, petit tour</a>
              <p datetime="28 January 2016">12

Décembre

2016
</p>
              <hr />
              <div class="similar_excerpt">
                <p><p>Ca y est, une nouvelle version de Neovim vient de sortir! Et avec elle sont lot de fonctionalités et de corrections bien sympa (voire même plus que sympa vous allez voir ;) ), profitons-en pour revoir les fonctionalités cool de Neovim</p>

</p>
              </div>
            </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
            <li>
              <a href="/planet/2016/03/08/nyaovim-le-gui-neovim-avec-electron.html">Nyaovim le GUI Neovim avec Electron</a>
              <p datetime="28 January 2016">8

Mars
  
2016
</p>
              <hr />
              <div class="similar_excerpt">
                <p><p>Voilà un projet dont j’avais plusieurs fois entendu parler mais sans jamais réellement me pencher dessus. Le seul défaut que je trouvais à Neovim c’est de ne pas avoir de GUI associé vraiment digne de ce nom, ce que je cherche est quelque chose de joli principalement mais aussi qui permette vraiment de profiter d’une interface graphique: prévisualisation, barre de défilement, bulle d’information et autre, etc…</p>

</p>
              </div>
            </li>
          
        
          
            <li>
              <a href="/planet/2016/01/28/generation-de-c++-en-plugin-neovim-avec-clang.html">Génération de code C++ en plugin Neovim avec CLang</a>
              <p datetime="28 January 2016">28

Janvier
  
2016
</p>
              <hr />
              <div class="similar_excerpt">
                <p><p>La Piscine de C++ qui marque le début de notre deuxième année à Epitech vient de se terminer. Durant ces deux semaines on étudie à fond la quasi-totalité des concepts liés à la POO.</p>

</p>
              </div>
            </li>
          
        
          
        
          
        
          
            <li>
              <a href="/planet/2015/12/16/ultisnips-autocompletion-html.html">Ultisnips: Autocomplétion HTML</a>
              <p datetime="28 January 2016">16

Décembre

2015
</p>
              <hr />
              <div class="similar_excerpt">
                <p><p>Pour ceux qui ne le savent pas, Ultisnips est un plugin pour Vim/NeoVim qui permet de créer des snippets. C’est l’outil le plus puissant de création de snippet que j’ai pu voir jusque maintenant, tout éditeur confondu. Les possibilités offertes par ce plugin sont immense, alors qu’il est très simple d’utilisation, a partir du moment où l’on sait exactement ce que l’on veut faire.</p>

</p>
              </div>
            </li>
          
        
          
        
          
        
          
        
          
        
          
            <li>
              <a href="/planet/2015/09/21/topo-de-mes-plugins-vim-02.html">Topo de mes plugins Vim - 02</a>
              <p datetime="28 January 2016">21

Septembre
  
2015
</p>
              <hr />
              <div class="similar_excerpt">
                <p><p>Les plugins c’est vraiment le top, alors dans Vim je vous en parle même pas, c’est comme rajouter des animations CSS, si je ne fait pas attention j’en rajoute un peu partout! Depuis la dernière fois j’ai rajouté quelque plugins qui ne révolutionnent pas mon utilisation de Vim, mais restent quand même un petit plus agréable. Du coup aujourd’hui ça va être plus court mais il y aura plus de monde ;)</p>

</p>
              </div>
            </li>
          
        
          
            <li>
              <a href="/planet/2015/09/16/topo-des-plugins-vim-01.html">Topo de mes plugins Vim - 01</a>
              <p datetime="28 January 2016">16

Septembre
  
2015
</p>
              <hr />
              <div class="similar_excerpt">
                <p><p>Au fil des mois de mes utilisations de Vim, je finis par emmagasiner un bon paquet de plugins, dont je me sers plus ou moins souvent selon ma capacité à me souvenir de leur existence dans mes dossier. Et le gros problème que j’ai avec ces plugins c’est que je pour beaucoup je ne me souviens jamais de comment ils fonctionnent de A à Z, et j’aime avoir une documentation complète pour me rappeler tout ça.</p>

</p>
              </div>
            </li>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      </ul>
    </div>
    

    <script type="text/javascript">
( function() {
  if (window.CHITIKA === undefined) { window.CHITIKA = { 'units' : [] }; };
  var unit = {"calltype":"async[2]","publisher":"ilphrin","width":728,"height":90,"sid":"Chitika Default"};
  var placement_id = window.CHITIKA.units.length;
  window.CHITIKA.units.push(unit);
  document.write('<div id="chitikaAdBlock-' + placement_id + '"></div>');
}());
    </script>
    <script type="text/javascript" src="//cdn.chitika.net/getads.js" async></script>
    <article>
      <p>La Piscine de C++ qui marque le début de notre deuxième année à Epitech vient de se terminer. Durant ces deux semaines on étudie à fond la quasi-totalité des concepts liés à la POO.</p>

<p>Rapidement tout le monde a commencé à chercher tout ce qui pouvait nous faciliter la vie pour coder, et de nombreux étudiants se sont tournés vers des IDE très puissants, mais aussi très lourds. Moi je suis du genre à rester sur mon Neovim même si j’ai moins de fonctionalités, au moins ça marche et je sais ce que je code.</p>

<p>Mais mon égo en a pris un coup au vu de toutes les fonctionnalités de ces IDE et j’ai eu envie de développer un plugin qui puisse faire, à défaut de complètement, certaines choses de façon équivalentes à ces IDE. Pour ça j’ai dû apprendre à utiliser l’API Python de Neovim, et la librairie de parsing CLang.</p>

<p>Mon plugin en est à ses balbutiements mais je compte bien l’améliorer au fil du temps. Je vais commencer par parler un peu de la création d’un plugin dans Neovim, puis du fonctionnement de CLang. Dans un prochain article je rentrerais un peu plus dans les détails sur la façon dont j’ai fait fonctionner les deux ensembles, mais cet article est déjà bien assez long ;)</p>

<!--break-->

<h2 id="neovim">Neovim</h2>

<p>Neovim a totalement changé son API pour les plugin par rapport à Vim, en utilisant <a href="http://msgpack.org/">msgpack</a> pour pouvoir créer des clients comme on veut dans le langage qu’on veut pour faire une API, un GUI, etc…</p>

<p>Dans mon cas je connais le Python, il y a une API Python, du coup je l’ai codé en Python, tout le monde suit? ;) Mais il y a de nombreux autres clients, vous pouvez voir la liste <a href="https://github.com/neovim/neovim/wiki/Related-projects">ICI</a>.</p>

<p>Pour m’aider j’y suis allé pas-à-pas en suivant plusieurs exemples donnés sur le dépôt de <a href="https://github.com/neovim/python-client">l’API Python</a>.</p>

<p>Bon assez parlé place à l’action, comment ça fonctionne un plugin Neovim avec Python? Déjà il faut installer cette API, cela se fait par le biais de la commande suivante:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">sudo pip install neovim</code></pre></figure>

<p>J’ai appelé mon plugin <a href="https://github.com/Ilphrin/easy-cpp.nvim">easy-cpp.nvim</a>, je met dans un dossier éponyme le contenu de mon plugin, qui se résume par:</p>

<ul>
  <li>Un README.md qui fera office d’introduction notamment sur Github</li>
  <li>Un fichier LICENSE (MIT dans mon cas, j’aime bien cette license :3)</li>
  <li>Un dossier rplugin/python</li>
</ul>

<p>rplugin est pour Remote Plugin, c’est-à-dire les plugins qui son gérés grâce a une API client telle que celle de Python. et le dossier python permet d’indiquer pour quel langage ce plugin est destiné.</p>

<p>Ce dossier est lui-même composé du:</p>

<ul>
  <li>dossier easy-cpp/ qui va contenir tout le code, qui pour le moment n’est que dans un fichier <strong>init</strong>.py parce que je suis sale</li>
  <li>fichier easy-cpp.py, qui est vide et qui le restera.</li>
</ul>

<p>Allons ensuite maintenant dans ce fichier <strong>init</strong>.py. Il contient principalement une classe avec un décorateur de neovim pour indiquer que cette classe dirige le plugin. Cette classe est initialisée avec un paramètre qui est le client de vim en lui-même. Cet objet va servir à faire toute l’interaction avec notre éditeur de texte préferé.</p>

<pre><code class="python">

@neovim.plugin
class Easy(object):
  def __init__(self, vim):
    self.vim = vim
    ...

  @neovim.command('EasyGenerate')
  def generate(self):
    ...

</code></pre>

<p>On voit ici que j’ai utilisé deux décorateurs liés à neovim. @neovim.plugin permet donc de marquer votre classe comme étant celle qui gère le plugin comme je l’ai déjà dit. @neovim.command est à placer sur une méthode de votre classe.</p>

<p>Elle va permettre de transformer votre méthode en commande pour Neovim. C’est-à-dire qu’une fois Neovim lancé, on peut taper :EasyGenerate et la fonction generate() va être lancée. Dans le principe c’est le gros de ce qu’il y a a apprendre pour créer un plugin pour Neovim. Mais il y a encore une chose dont je doit parler et qui est essentiel pour insérer du texte dans un fichier: la variable Buffer.</p>

<p>On a notre objet self.vim qui contient énormément d’informations sur l’état actuel de l’éditeur (je vous invite a voir les fichiers de tests unitaires de l’API Python qui contiennent pas mal d’information sur le sujet). Parmis les variables qu’il contient j’ai principalement eu à utiliser self.vim.current.buffer et self.vim.buffers</p>

<p>self.vim.buffers est un tableau qui contient chacune des lignes qui existent dans chacun des buffers ouverts. Le premier niveau du tableau (buffers[0], buffers[1], etc…) contient tour à tour les buffers ouverts. Le deuxième niveau (buffers[0][2], buffers[4][1:5], etc…). Pour modifier il suffit d’assigner une chaine de caractère à une ligne d’un buffer, ou meme un tableau de chaines de caractères.</p>

<p>Pour ajouter à la fin d’un buffer il y a deux possibilités: soit on veut ajouter à la fin et dans ce cas on fait buffers.append(maChaineOuMonTableau), soit on veut intercaler une ou des lignes entre deux autres, par exemple si je veux insérer du texte à la ligne 42 je fais buffers.append(maChainOuMonTableau, 42). Au final c’est comme un tableau classique en Python :)</p>

<h2 id="clang">CLang</h2>

<p>CLang est extrêmement puissant, mais il n’y a malheureusement que peu de ressources documentaires sur le sujet, et encore moins pour la librairie en Python. Ayant réussi à faire deux trois chose avec je me suis dit que partager avec tout le monde ce que j’ai appris pourrait en pousser d’autres à faire le pas ;) (et m’apprendre des choses en retour!)</p>

<p>J’ai commencé par suivre ce tutoriel tout d’abord aux conseil de mon ami <a href="https://github.com/Strackeror">Strackeror</a>: <a href="http://szelei.me/code-generator/">http://szelei.me/code-generator/</a>.</p>

<p>Ce tutoriel est très bien écrit (mais en anglais bien sûr), et il vous donne les bases pour comprendre CLang et l’utiliser dans Python. Mais dans mon cas je ne l’ai pas suivi en entier car mon but était un peu différent de ce qu’il voulait faire. Mon but est d’utiliser CLang pour analyser un fichier d’en-tête C++, et en extirper les prototypes de chaque méthode avec leur espace de nom.</p>

<p>Je m’explique, j’ai fait un fichier de header pour mes tests, et un fichier de source pour comparer le résultat final que je veux:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#ifndef TEXTCOMPONENT_H
# define TEXTCOMPONENT_H
</span>
<span class="cp">#include &lt;string&gt;
</span>
<span class="k">namespace</span> <span class="n">Test</span>
<span class="p">{</span>
  <span class="k">namespace</span> <span class="n">inerTest</span>
  <span class="p">{</span>
    <span class="k">class</span> <span class="nc">TextComponent</span>
    <span class="p">{</span>
      <span class="k">public</span><span class="o">:</span>
          <span class="n">TextComponent</span><span class="p">();</span>

          <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">text</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
          <span class="kt">void</span> <span class="n">setText</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">);</span>

      <span class="k">private</span><span class="o">:</span>
          <span class="kt">void</span> <span class="n">superSecretFunction</span><span class="p">();</span>
          <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_text</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="k">class</span> <span class="nc">newText</span>
  <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
      <span class="n">newText</span><span class="p">();</span>
      <span class="n">newText</span><span class="p">(</span><span class="n">newText</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">);</span>
      <span class="n">newText</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">newText</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">);</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">OutText</span>
<span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">OutText</span><span class="p">();</span>
    <span class="n">OutText</span><span class="p">(</span><span class="n">OutText</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">);</span>
    <span class="n">OutText</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">OutText</span> <span class="k">const</span><span class="o">&amp;</span><span class="p">);</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="n">outputsmthing</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* TEXTCOMPONENT_H */</span></code></pre></figure>

<p>Et ce que je veux obtenir:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp">#include "textcomponent.h"
</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">Test</span><span class="o">::</span><span class="n">inerTest</span><span class="o">::</span><span class="n">TextComponent</span><span class="o">::</span><span class="n">text</span><span class="p">()</span> <span class="k">const</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">Test</span><span class="o">::</span><span class="n">inerTest</span><span class="o">::</span><span class="n">TextComponent</span><span class="o">::</span><span class="n">setText</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">Test</span><span class="o">::</span><span class="n">inerTest</span><span class="o">::</span><span class="n">TextComponent</span><span class="o">::</span><span class="n">superSecretFunction</span><span class="p">()</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="n">Test</span><span class="o">::</span><span class="n">newText</span> <span class="o">&amp;</span> <span class="n">Test</span><span class="o">::</span><span class="n">newText</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">Test</span><span class="o">::</span><span class="n">newText</span> <span class="o">&amp;</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="n">outputsmthing</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span>

<span class="n">OutText</span> <span class="o">&amp;</span> <span class="n">OutText</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">OutText</span> <span class="o">&amp;</span><span class="p">)</span>
<span class="p">{</span>

<span class="p">}</span></code></pre></figure>

<p>J’ai volontairement fait un cas pas très joli d’encapsulation dans des espaces de noms, mais bon au moins si là ça fonctionne c’est que je suis sur une bonne base!</p>

<p>Donc pour générer ça, on va avoir besoin d’installer clang pour python, pour ça rien de tel qu’un:</p>

<figure class="highlight"><pre><code class="language-sh" data-lang="sh">sudo pip install clang</code></pre></figure>

<p>Ensuite on ouvre un fichier python à coté de notre fichier header (je ne parle pas du fichier <strong>init</strong>.py de tout à l’heure là on se met dans un autre dossier pour travailler sur autre chose sans le lier au plugin). On commence ce fichier en initialisant clang, lui demandant de créer un index, et de parser un fichier donné en paramètre avec sys.argv[]. Enfin, on va utiliser la sortie pour génerer la liste des fonctions du fichier de header:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="kn">from</span> <span class="nn">clang</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">cindex</span><span class="o">.</span><span class="n">Config</span><span class="o">.</span><span class="n">set_library_file</span><span class="p">(</span><span class="s">'/usr/lib/llvm-3.4/lib/libclang.so.1'</span><span class="p">)</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">cindex</span><span class="o">.</span><span class="n">Index</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
<span class="n">translation_unit</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="s">'-x'</span><span class="p">,</span> <span class="s">'c++'</span><span class="p">,</span> <span class="s">'-std=c++11'</span><span class="p">,</span> <span class="s">'-D__CODE_GENERATOR__'</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">get_methods</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">spelling</span>
    <span class="n">functions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">cindex</span><span class="o">.</span><span class="n">CursorKind</span><span class="o">.</span><span class="n">CXX_METHOD</span><span class="p">):</span>
            <span class="n">functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">functions</span>

<span class="k">def</span> <span class="nf">get_all_public_functions</span><span class="p">(</span><span class="n">cursor</span><span class="p">):</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">get_children</span><span class="p">():</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">cindex</span><span class="o">.</span><span class="n">CursorKind</span><span class="o">.</span><span class="n">CLASS_DECL</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="nb">file</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">a_class</span> <span class="o">=</span> <span class="n">get_methods</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">spelling</span><span class="p">]</span> <span class="o">=</span> <span class="n">a_class</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">cindex</span><span class="o">.</span><span class="n">CursorKind</span><span class="o">.</span><span class="n">NAMESPACE</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="nb">file</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">child_classes</span> <span class="o">=</span> <span class="n">get_all_public_functions</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">spelling</span><span class="p">]</span> <span class="o">=</span> <span class="n">child_classes</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">cindex</span><span class="o">.</span><span class="n">CursorKind</span><span class="o">.</span><span class="n">FUNCTION_DECL</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="nb">file</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">spelling</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">result</span>

<span class="n">classes</span> <span class="o">=</span> <span class="n">get_all_public_functions</span><span class="p">(</span><span class="n">translation_unit</span><span class="o">.</span><span class="n">cursor</span><span class="p">)</span></code></pre></figure>

<p>Pas de panique je vais tout expliquer!</p>

<p>Les premières lignes sont expliquées dans l’article que j’ai mis en lien plus haut, je ne pense pas avoir besoin de revenir dessus.</p>

<p>Tout en bas on assigne à classes le retour de la fonction get_all_public_functions qui prend en paramètre un objet Cursor. Cet objet propre a CLang contient tout un tas d’informations sur chaque segment de code, sous forme d’arbre.</p>

<p>Dans get_all_public_functions() on parcourt la liste des enfants de ce Cursor avec la méthode get_children(), la variable c obtenue est un…Cursor, vu que nous sommes dans un arbre de Cursors, chaque enfant est un autre Cursor dépendant de son parent.</p>

<p>Cet objet contient de nombreuses informations, dont c.kind qui indique le type du Cursor. Dans notre cas on vérifie pour trois valeurs:</p>

<ul>
  <li>Si c’est un classe (CLASS_DECL), dans ce cas-là on appelle la fonction get_methods() plus haut qui récupère toutes les méthodes de cette classe.</li>
  <li>Si c’est un namespace (NAMESPACE) on recupère de façon récursive le retour de get_all_public_functions() avec comme valeur l’enfant courant. Puis on l’ajoute à result.</li>
  <li>Si c’est une fonction (FUNCTION_DECL), on l’ajoute simplement à result.</li>
</ul>

<p>result étant un dictionnaire, on lui passe en guise le clé c.spelling, qui correspond au code en lui-même pointé par le curseur, dans notre cas c’est soit un nom de classe, soit un nom de namespace, soit un nom de fonction.</p>

<p>Petit détail, la condition c.location.file.name == sys.argv[1] permet de vérifier qu’on parle toujours du même fichier, et pas d’un fichier récuperé lors d’un #include, qui sera aussi parsé par CLang quoiqu’on fasse, sauf qu’on veut pas l’ajouter en résultat ;)</p>

<p>La suite au prochain épisode…</p>

    </article>
  </div>
</div>

<div id="share" class="ui segment inverted">
  <h2>Vous avez aimé cet article? Partagez-le</h2>
  <a href="https://twitter.com/share?text='Génération de code C++ en plugin Neovim avec CLang /planet/2016/01/28/generation-de-c++-en-plugin-neovim-avec-clang.html'" target="_blank">
    <i class="big twitter icon"></i>
    <span>Twitter</span>
  </a>
  <a href="http://sharetodiaspora.github.io/?title=Génération de code C++ en plugin Neovim avec CLang&url=/planet/2016/01/28/generation-de-c++-en-plugin-neovim-avec-clang.html" target="_blank">
    <i class="big icon star"></i>
    <span>Diaspora*</span>
  </a>
</div>
<div id="comments" itemprop="comment">
  
  
      
      
  
      
      
  
      
      
  
  <form class="ui form" method="POST" action="https://api.staticman.net/v2/entry/Ilphrin/ilphrin.com/master/comments">
    <input name="options[slug]" type="hidden" value="generation-de-c++-en-plugin-neovim-avec-clang">
    <input name="options[redirect]" type="hidden" value="https://ilphrin.com/planet/2016/01/28/generation-de-c++-en-plugin-neovim-avec-clang.html">
    <input name="options[origin]" type="hidden" value="https://ilphrin.com" />
    <input type="hidden" name="fields[post_id]" value="/planet/2016/01/28/generation-de-c++-en-plugin-neovim-avec-clang" />
    <div class="ui inverted segment">
      <h2 class="ui dividing header">Commenter</h2>
      <p style="font-style: italic">
      Tous les commentaires sont sujet à modération. Un formatage HTML basique est utilisable
      </p>
      <div class="field">
        <div class="three fields">
          <div class="field">
            <label>Nom</label>
            <input name="fields[name]" placeholder="Requis" type="text" required/>
          </div>
          <div class="field">
            <label>Email</label>
            <input name="fields[email]" placeholder="Requis, non publié" type="email" required/>
          </div>
          <div class="field">
            <label>Lien</label>
            <input name="fields[url]" placeholder="Optionnel" type="text"/>
          </div>
        </div>
      </div>
      <div class="field">
        <label>Allez-y parlez ;)</label>
        <textarea name="fields[message]" placeholder="Requis" required></textarea>
      </div>
      <button class="ui submit button" type="submit" name="submit">Envoyer</button>
    </div>
  </form>
</div>



    </div>

  <script src="/js/previous.js" charset="utf-8"></script>
  <script src="/js/header.js" charset="utf-8"></script>
  <script type="text/javascript" src="/js/analytics.js"></script>

  <!-- Piwik -->
  <noscript><p><img src="//ilphrin.com/analytics/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
  <!-- End Piwik Code -->

  <script src="/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="/bower_components/mermaid/dist/mermaid.min.js" charset="utf-8"></script>
  <script defer>mermaid.initialize({startOnLoad:true});</script>


  <script src="/bower_components/jquery/dist/jquery.min.js" charset="utf-8"></script>
  <script src="/bower_components/semantic/dist/semantic.min.js" charset="utf-8"></script>
</body>
</html>
